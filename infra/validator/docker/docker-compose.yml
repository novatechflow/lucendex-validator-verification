version: '3.8'

services:
  rippled:
    # SECURITY: Using pinned SHA256 digest instead of :latest
    # Verify digest with: ./scripts/verify-rippled-image.sh
    # Official source: https://hub.docker.com/r/rippleci/rippled/tags
    image: rippleci/rippled@sha256:467dde2bf955dba05aafb2f6020bfd8eacf64cd07305b41d7dfc3c8e12df342d
    container_name: rippled
    hostname: xrpl-validator
    restart: unless-stopped
    
    # Security hardening
    read_only: false  # rippled needs to write to database
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    
    # Resource limits - OPTIMIZED for 24GB RAM
    # Headroom for validation spikes (can reach 10GB during peer churn)
    # Leaves 3GB for OS
    deploy:
      resources:
        limits:
          memory: 21g
          cpus: '3.5'
        reservations:
          memory: 12g
    
    # Ports
    ports:
      - "51235:51235"     # Peer protocol
      - "127.0.0.1:5005:5005"   # Admin RPC (localhost only)
      - "127.0.0.1:6006:6006"   # WebSocket (localhost only)
    
    # Volumes
    volumes:
      - ./config/rippled.cfg:/etc/opt/ripple/rippled.cfg:ro
      - rippled-data:/var/lib/rippled
      - rippled-log:/var/log/rippled
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
    
    # Health check - DISABLED to debug restart issue
    # healthcheck:
    #   test: ["CMD", "/opt/ripple/bin/rippled", "--conf", "/etc/opt/ripple/rippled.cfg", "server_info"]
    #   interval: 60s
    #   timeout: 30s
    #   retries: 5
    #   start_period: 120s
    
    # File descriptor limits (equivalent to LimitNOFILE)
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    
    # Environment
    environment:
      - TZ=UTC

volumes:
  rippled-data:
    driver: local
  rippled-log:
    driver: local
