.PHONY: help ssh status logs health peers consensus restart stop start deploy destroy clean backup restore

# Get validator IP from Terraform
VALIDATOR_IP := $(shell cd terraform && terraform output -raw validator_ip 2>/dev/null || echo "not-deployed")
SSH_KEY := terraform/validator_ssh_key
SSH_CMD := ssh -i $(SSH_KEY) root@$(VALIDATOR_IP)

help: ## Show this help message
	@echo "XRPL Validator Management Commands"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

ssh: ## SSH into validator
	@$(SSH_CMD)

status: ## Check validator status
	@echo "Checking validator status..."
	@$(SSH_CMD) "docker exec rippled /opt/ripple/bin/rippled server_info" | jq '.result.info.server_state'

sync-status: ## Check ledger sync progress
	@echo "=== Ledger Sync Status ==="
	@$(SSH_CMD) "docker exec rippled /opt/ripple/bin/rippled server_info 2>/dev/null" | jq -r '.result.info | {state: .server_state, complete_ledgers, validated_ledger: .validated_ledger.seq, peers, load_factor, uptime: .uptime}'
	@echo ""
	@echo "Network ledger (mainnet):"
	@curl -s https://s1.ripple.com:51234 -X POST -H "Content-Type: application/json" -d '{"method":"ledger","params":[{"ledger_index":"validated"}]}' | jq -r '.result.ledger_index // "unavailable"'

logs: ## View rippled logs (follow mode)
	@echo "Following rippled logs (Ctrl+C to exit)..."
	@$(SSH_CMD) "docker logs -f rippled"

logs-tail: ## View last 100 lines of rippled logs
	@$(SSH_CMD) "docker logs --tail 100 rippled"

# Removed: health (duplicates sync-status)

peers: ## Show connected peers
	@$(SSH_CMD) "docker exec rippled /opt/ripple/bin/rippled peers" | jq -e '.result.peers[]? | {address, type, version}' || echo "No peer data available (rippled may still be starting)"

consensus: ## Show consensus participation
	@$(SSH_CMD) "docker exec rippled /opt/ripple/bin/rippled consensus_info"

# Removed: ledger (duplicates sync-status)

restart: ## Restart rippled container
	@echo "Restarting rippled..."
	@$(SSH_CMD) "cd /opt/rippled && docker-compose restart"
	@echo "✓ Rippled restarted"

stop: ## Stop rippled container
	@echo "Stopping rippled..."
	@$(SSH_CMD) "cd /opt/rippled && docker-compose stop"
	@echo "✓ Rippled stopped"

start: ## Start rippled container
	@echo "Starting rippled..."
	@$(SSH_CMD) "cd /opt/rippled && docker-compose start"
	@echo "✓ Rippled started"

resources: ## Check VM resource usage
	@echo "CPU and Memory Usage:"
	@$(SSH_CMD) "top -bn1 | head -5"
	@echo ""
	@echo "Disk Usage:"
	@$(SSH_CMD) "df -h /"
	@echo ""
	@echo "Docker Stats:"
	@$(SSH_CMD) "docker stats --no-stream rippled"

# Removed: disk (duplicates resources command)

updates: ## Check for system updates
	@echo "Checking for updates..."
	@$(SSH_CMD) "apt update && apt list --upgradable"

firewall-status: ## Show firewall status
	@$(SSH_CMD) "ufw status verbose"

test-connectivity: ## Test XRPL peer connectivity
	@echo "Testing peer connectivity on port 51235..."
	@nc -zv $(VALIDATOR_IP) 51235 || echo "Port not reachable"

backup: ## Backup validator configuration
	@echo "Creating backup..."
	@mkdir -p backups/$$(date +%Y%m%d_%H%M%S)
	@scp -i $(SSH_KEY) root@$(VALIDATOR_IP):/opt/rippled/rippled.cfg backups/$$(date +%Y%m%d_%H%M%S)/
	@scp -i $(SSH_KEY) root@$(VALIDATOR_IP):/opt/rippled/docker-compose.yml backups/$$(date +%Y%m%d_%H%M%S)/
	@echo "✓ Backup saved to backups/$$(date +%Y%m%d_%H%M%S)/"

verify-backup: ## Verify latest backup integrity
	@echo "Verifying backup integrity..."
	@ls -lh backups/$$(ls -t backups | head -1)

update-config: ## Update rippled configuration
	@echo "Uploading new configuration..."
	@scp -i $(SSH_KEY) docker/rippled.cfg root@$(VALIDATOR_IP):/opt/rippled/
	@echo "Configuration updated. Restart required: make restart"

verify-image: ## Verify rippled Docker image authenticity
	@./scripts/verify-rippled-image.sh

deploy: ## Run deployment script
	@./deploy.sh

destroy: ## Destroy infrastructure (WARNING: irreversible)
	@echo "WARNING: This will destroy all infrastructure!"
	@read -p "Type 'destroy' to confirm: " confirm && [ "$$confirm" = "destroy" ]
	@cd terraform && terraform destroy
	@echo "✓ Infrastructure destroyed"

clean: ## Clean local artifacts
	@rm -rf terraform/.terraform
	@rm -f terraform/*.tfstate*
	@rm -f terraform/tfplan
	@echo "✓ Local artifacts cleaned"

# Consolidated key management commands
keys: ## Show validator keys (public key + seed)
	@echo "=== Validator Keys ==="
	@echo ""
	@echo "Public Key (from running validator):"
	@$(SSH_CMD) "docker exec rippled /opt/ripple/bin/rippled server_info 2>/dev/null | jq -r '.result.info.pubkey_validator // \"Not validating (tracking mode)\"'"
	@echo ""
	@echo "Validation Seed (from config - ⚠️  PRIVATE!):"
	@$(SSH_CMD) "grep -A 1 '^\[validation_seed\]' /opt/rippled/rippled.cfg 2>/dev/null | tail -1 | xargs || echo 'No validation_seed in config'"
	@echo ""
	@echo "Use public key for UNL registration & DNS TXT record"
	@echo "⚠️  NEVER share the validation seed!"
	@echo ""

config: ## Show full rippled configuration
	@echo "=== rippled.cfg ==="
	@$(SSH_CMD) "cat /opt/rippled/rippled.cfg"

version: ## Show rippled version
	@$(SSH_CMD) "docker exec rippled /opt/ripple/bin/rippled --version"

info: ## Show deployment info
	@echo "Validator Information"
	@echo "===================="
	@echo "IP Address: $(VALIDATOR_IP)"
	@echo "SSH Key: $(SSH_KEY)"
	@echo "SSH Command: $(SSH_CMD)"
	@echo ""
	@echo "Quick access: make ssh"
