version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: lucendex-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: lucendex
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - postgres-wal:/var/lib/postgresql/wal_archive
      - postgres-ssl:/var/lib/postgresql/ssl:ro
      - ./postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    ports:
      - "5432:5432"
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    networks:
      - lucendex
    # Resource limits - OPTIMIZED for 64GB RAM + 16GB zram
    deploy:
      resources:
        limits:
          memory: 3g
        reservations:
          memory: 2g
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # rippled API Node (fast RPC)
  rippled-api:
    # SECURITY: Using pinned SHA256 digest (2.6.1)
    # Verify: docker pull rippleci/rippled:2.6.1 | grep Digest
    image: rippleci/rippled@sha256:467dde2bf955dba05aafb2f6020bfd8eacf64cd07305b41d7dfc3c8e12df342d
    container_name: lucendex-rippled-api
    restart: always
    init: true
    volumes:
      - rippled-api-data:/var/lib/rippled
      - rippled-api-logs:/var/log/rippled
      - ./rippled-api.cfg:/etc/opt/ripple/rippled.cfg:ro
    ports:
      - "51234:51234"  # RPC
      - "6005:6005"    # WebSocket
      - "51235:51235"  # Peer
    networks:
      - lucendex
    # Resource limits - OPTIMIZED for 16-core/64GB RAM + 16GB zram
    deploy:
      resources:
        limits:
          cpus: '6.0'
          memory: 28g
        reservations:
          cpus: '3.0'
          memory: 16g
    # File descriptor limits
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    # Kernel tuning
    sysctls:
      - net.core.somaxconn=4096
    # DISABLED: Healthcheck may be causing restarts during sync
    # healthcheck:
    #   test: ["CMD-SHELL", "rippled server_info | grep -q server_state"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 60s

  # rippled Full-History Node (indexer feed)
  rippled-history:
    # SECURITY: Using pinned SHA256 digest (2.6.1)
    # Verify: docker pull rippleci/rippled:2.6.1 | grep Digest
    image: rippleci/rippled@sha256:467dde2bf955dba05aafb2f6020bfd8eacf64cd07305b41d7dfc3c8e12df342d
    container_name: lucendex-rippled-history
    restart: always
    init: true
    volumes:
      - rippled-history-data:/var/lib/rippled
      - rippled-history-logs:/var/log/rippled
      - ./rippled-history.cfg:/etc/opt/ripple/rippled.cfg:ro
    ports:
      - "6006:6006"    # WebSocket (internal only)
      - "51236:51236"  # Peer
    networks:
      - lucendex
    # Resource limits - OPTIMIZED for 16-core/64GB RAM + 16GB zram (history needs most RAM)
    deploy:
      resources:
        limits:
          cpus: '8.0'
          memory: 36g
        reservations:
          cpus: '4.0'
          memory: 24g
    # File descriptor limits
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    # Kernel tuning
    sysctls:
      - net.core.somaxconn=4096
    # DISABLED: Healthcheck may be causing restarts during sync
    # healthcheck:
    #   test: ["CMD-SHELL", "rippled server_info | grep -q server_state"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 60s

volumes:
  postgres-data:
    external: true
    name: docker_postgres-data
  postgres-wal:
    external: true
    name: docker_postgres-wal
  postgres-ssl:
    external: true
    name: docker_postgres-ssl
  rippled-api-data:
    driver: local
  rippled-api-logs:
    driver: local
  rippled-history-data:
    driver: local
  rippled-history-logs:
    driver: local

networks:
  lucendex:
    driver: bridge
