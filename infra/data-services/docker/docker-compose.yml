version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: lucendex-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: lucendex
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - postgres-wal:/var/lib/postgresql/wal_archive
      - postgres-ssl:/var/lib/postgresql/ssl:ro
      - ./postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    ports:
      - "5432:5432"
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    networks:
      - lucendex
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # rippled API Node (fast RPC)
  rippled-api:
    image: xrpllabsofficial/xrpld:2.2.0
    container_name: lucendex-rippled-api
    restart: unless-stopped
    volumes:
      - rippled-api-data:/var/lib/rippled
      - rippled-api-logs:/var/log/rippled
      - ./rippled-api.cfg:/etc/opt/ripple/rippled.cfg:ro
    ports:
      - "51234:51234"  # RPC
      - "6005:6005"    # WebSocket
      - "51235:51235"  # Peer
    networks:
      - lucendex
    healthcheck:
      test: ["CMD-SHELL", "rippled server_info | grep -q server_state"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # rippled Full-History Node (indexer feed)
  rippled-history:
    image: xrpllabsofficial/xrpld:2.2.0
    container_name: lucendex-rippled-history
    restart: unless-stopped
    volumes:
      - rippled-history-data:/var/lib/rippled
      - rippled-history-logs:/var/log/rippled
      - ./rippled-history.cfg:/etc/opt/ripple/rippled.cfg:ro
    ports:
      - "6006:6006"    # WebSocket (internal only)
      - "51236:51236"  # Peer
    networks:
      - lucendex
    healthcheck:
      test: ["CMD-SHELL", "rippled server_info | grep -q server_state"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  postgres-data:
    external: true
    name: docker_postgres-data
  postgres-wal:
    external: true
    name: docker_postgres-wal
  postgres-ssl:
    external: true
    name: docker_postgres-ssl
  rippled-api-data:
    driver: local
  rippled-api-logs:
    driver: local
  rippled-history-data:
    driver: local
  rippled-history-logs:
    driver: local

networks:
  lucendex:
    driver: bridge
