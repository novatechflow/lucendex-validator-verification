#cloud-config
# Cloud-init configuration for XRPL Data Services
# Components: rippled API + rippled Full-History + PostgreSQL + Backend services

hostname: ${hostname}
manage_etc_hosts: true

# System updates
package_update: true
package_upgrade: true

# Install essential packages
packages:
  - curl
  - wget
  - git
  - htop
  - vim
  - jq
  - ufw
  - fail2ban
  - unattended-upgrades
  - apt-transport-https
  - ca-certificates
  - gnupg
  - lsb-release
  - postgresql-client
  - make

# Configure automatic security updates
write_files:
  - path: /etc/apt/apt.conf.d/50unattended-upgrades
    content: |
      Unattended-Upgrade::Allowed-Origins {
          "$${distro_id}:$${distro_codename}";
          "$${distro_id}:$${distro_codename}-security";
          "$${distro_id}ESMApps:$${distro_codename}-apps-security";
          "$${distro_id}ESM:$${distro_codename}-infra-security";
      };
      Unattended-Upgrade::AutoFixInterruptedDpkg "true";
      Unattended-Upgrade::MinimalSteps "true";
      Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "false";

  - path: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
      APT::Periodic::AutocleanInterval "7";

  - path: /root/.pgpass
    content: |
      localhost:5432:lucendex:postgres:${postgres_password}
      localhost:5432:lucendex:indexer_rw:${indexer_db_password}
      localhost:5432:lucendex:router_ro:${router_db_password}
      localhost:5432:lucendex:api_ro:${api_db_password}
    permissions: '0600'

  - path: /opt/lucendex/.env
    content: |
      # Database passwords
      POSTGRES_PASSWORD=${postgres_password}
      INDEXER_DB_PASSWORD=${indexer_db_password}
      ROUTER_DB_PASSWORD=${router_db_password}
      API_DB_PASSWORD=${api_db_password}
      
      # Indexer configuration (auto-generated)
      DATABASE_URL=postgres://indexer_rw:${indexer_db_password}@localhost:5432/lucendex?sslmode=disable
      RIPPLED_WS=ws://localhost:6006
      
      # Router configuration (M1 - for future use)
      ROUTER_DB_URL=postgres://router_ro:${router_db_password}@localhost:5432/lucendex?sslmode=require
      
      # API configuration (M2 - for future use)
      API_DB_URL=postgres://api_ro:${api_db_password}@localhost:5432/lucendex?sslmode=require
    permissions: '0600'

# UFW firewall configuration and PostgreSQL SSL setup
runcmd:
  - systemctl enable unattended-upgrades
  - systemctl start unattended-upgrades
  - systemctl enable fail2ban
  - systemctl start fail2ban
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp comment 'SSH'
  - ufw allow 51234/tcp comment 'rippled API RPC'
  - ufw allow 6005/tcp comment 'rippled API WebSocket'
  - ufw allow 51235/tcp comment 'rippled API peer'
  - ufw allow 51236/tcp comment 'rippled History peer'
  - echo "y" | ufw enable
  - mkdir -p /opt/lucendex
  - chown root:root /opt/lucendex
  - chmod 755 /opt/lucendex
  - mkdir -p /var/lib/postgresql
  - sh -c 'openssl req -new -newkey rsa:2048 -x509 -sha256 -days 365 -nodes -subj "/C=MT/ST=Malta/L=Valletta/O=Lucendex/CN=postgres.lucendex.local" -keyout /var/lib/postgresql/server.key -out /var/lib/postgresql/server.crt'
  - chmod 600 /var/lib/postgresql/server.key
  - chmod 644 /var/lib/postgresql/server.crt
  - chown 70:70 /var/lib/postgresql/server.* || true

# Set timezone
timezone: UTC

# Final message
final_message: "XRPL Data Services cloud-init complete. System ready for Docker and services deployment."
